<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>할일 앱</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <h1>할일 목록</h1>

    <div class="input-section">
      <input type="text" id="todoInput" placeholder="할일을 입력하세요..." />
      <button id="addBtn">추가</button>
    </div>

    <ul id="todoList"></ul>
  </div>

  <script type="module">
    // Firebase SDK 로드
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, set, get, update, remove, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // Firebase 설정
    const firebaseConfig = {
      apiKey: "AIzaSyCmh4wr2uK_mtUkvRdnh8a46BM1mxy3XSc",
      authDomain: "noona-todo-backend-827df.firebaseapp.com",
      databaseURL: "https://noona-todo-backend-827df-default-rtdb.firebaseio.com",
      projectId: "noona-todo-backend-827df",
      storageBucket: "noona-todo-backend-827df.firebasestorage.app",
      messagingSenderId: "24457967002",
      appId: "1:24457967002:web:218281a2279a8b8486b623"
    };

    // Firebase 초기화
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const todosRef = ref(db, 'todos');

    // DOM 요소
    const todoInput = document.getElementById('todoInput');
    const addBtn = document.getElementById('addBtn');
    const todoList = document.getElementById('todoList');

    // HTML 이스케이프 (XSS 방지)
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // 할일 렌더링
    function renderTodos(todos) {
      if (todos.length === 0) {
        todoList.innerHTML = '<li class="empty-message">할일이 없습니다. 새로운 할일을 추가해보세요!</li>';
        return;
      }

      todoList.innerHTML = todos.map((todo) => `
        <li class="todo-item ${todo.completed ? 'completed' : ''}" data-id="${todo.id}">
          <input type="checkbox" class="todo-checkbox" ${todo.completed ? 'checked' : ''} />
          <span class="todo-text">${escapeHtml(todo.text)}</span>
          <div class="btn-group">
            <button class="edit-btn">수정</button>
            <button class="delete-btn">삭제</button>
          </div>
        </li>
      `).join('');
    }

    // 실시간 데이터 리스너
    onValue(todosRef, (snapshot) => {
      const data = snapshot.val();
      const todos = [];
      if (data) {
        Object.keys(data).forEach((key) => {
          todos.push({ id: key, ...data[key] });
        });
      }
      renderTodos(todos);
    });

    // 할일 추가
    async function addTodo() {
      const text = todoInput.value.trim();
      if (!text) {
        todoInput.focus();
        return;
      }

      try {
        const newTodoRef = push(todosRef);
        await set(newTodoRef, {
          text: text,
          completed: false,
          createdAt: Date.now()
        });
        todoInput.value = '';
        todoInput.focus();
      } catch (error) {
        console.error("할일 추가 실패:", error);
      }
    }

    // 할일 삭제
    async function deleteTodo(id) {
      try {
        await remove(ref(db, `todos/${id}`));
      } catch (error) {
        console.error("할일 삭제 실패:", error);
      }
    }

    // 할일 완료 토글
    async function toggleTodo(id, completed) {
      try {
        await update(ref(db, `todos/${id}`), { completed: !completed });
      } catch (error) {
        console.error("할일 업데이트 실패:", error);
      }
    }

    // 할일 수정 모드
    function editTodo(id, li) {
      const todoText = li.querySelector('.todo-text');
      const btnGroup = li.querySelector('.btn-group');
      const currentText = todoText.textContent;

      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'todo-edit-input';
      input.value = currentText;
      todoText.replaceWith(input);

      btnGroup.innerHTML = `
        <button class="save-btn">저장</button>
        <button class="cancel-btn">취소</button>
      `;

      input.focus();
      input.select();

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          saveTodoEdit(id, input.value);
        } else if (e.key === 'Escape') {
          location.reload();
        }
      });
    }

    // 할일 수정 저장
    async function saveTodoEdit(id, newText) {
      const text = newText.trim();
      if (!text) {
        alert('할일을 입력해주세요.');
        return;
      }

      try {
        await update(ref(db, `todos/${id}`), { text: text });
      } catch (error) {
        console.error("할일 수정 실패:", error);
      }
    }

    // 이벤트 리스너
    addBtn.addEventListener('click', addTodo);

    todoInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        addTodo();
      }
    });

    todoList.addEventListener('click', (e) => {
      const li = e.target.closest('.todo-item');
      if (!li) return;

      const id = li.dataset.id;
      const isCompleted = li.classList.contains('completed');

      if (e.target.classList.contains('todo-checkbox')) {
        toggleTodo(id, isCompleted);
      } else if (e.target.classList.contains('delete-btn')) {
        deleteTodo(id);
      } else if (e.target.classList.contains('edit-btn')) {
        editTodo(id, li);
      } else if (e.target.classList.contains('save-btn')) {
        const input = li.querySelector('.todo-edit-input');
        saveTodoEdit(id, input.value);
      } else if (e.target.classList.contains('cancel-btn')) {
        location.reload();
      }
    });
  </script>
</body>
</html>
